#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo '[Husky] commit-msg hook...'

COMMIT_MSG_FILE="$1"
PROJECT_KEY="LB"
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)"

# Validate branch name: must contain e.g. LB-123
if printf '%s' "$BRANCH_NAME" | grep -Eq "^${PROJECT_KEY}-[0-9]+(/|$)"; then
  echo "Branch name OK: $BRANCH_NAME"
else
  printf "\n[ERROR] Branch name is invalid!\n"
  printf "Please name your branch with the Jira ticket number: %s-<num>/short-description\n" "$PROJECT_KEY"
  printf "Examples: %s-21 or %s-29/fix-css\n\n" "$PROJECT_KEY" "$PROJECT_KEY"
  printf "Tip: bypass with --no-verify if needed: git commit -m 'msg' --no-verify\n\n"
  exit 1
fi

JIRA_ISSUE_NUMBER="$(printf '%s' "$BRANCH_NAME" | sed 's#/.*##')"

# Append once if not already in commit message
if ! grep -q "Jira issue: ${JIRA_ISSUE_NUMBER}" "$COMMIT_MSG_FILE"; then
  printf "\n\nJira issue: %s\n" "$JIRA_ISSUE_NUMBER" >> "$COMMIT_MSG_FILE"
fi
