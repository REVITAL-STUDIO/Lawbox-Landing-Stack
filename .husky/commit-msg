#!/bin/sh

echo '[Husky] commit-msg hook...'

COMMIT_MSG_FILE="$1"
PROJECT_KEY="LB"
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || true)"

# Validate branch name: LB-<digits>[optional /suffix]
case "$BRANCH_NAME" in
  ${PROJECT_KEY}-[0-9]*|${PROJECT_KEY}-[0-9]*/*) echo "Branch name OK: $BRANCH_NAME" ;;
  *)
    printf "\n[ERROR] Branch name is invalid!\n"
    printf "Please name your branch: %s-<num>/short-description\n" "$PROJECT_KEY"
    printf "Examples: %s-21 or %s-29/fix-css\n\n" "$PROJECT_KEY" "$PROJECT_KEY"
    printf "Tip: bypass with --no-verify: git commit -m 'msg' --no-verify\n\n"
    exit 1
    ;;
esac

JIRA_ISSUE_NUMBER="$(printf '%s' "$BRANCH_NAME" | sed 's#/.*##')"

# Append once
if ! grep -q "Jira issue: ${JIRA_ISSUE_NUMBER}" "$COMMIT_MSG_FILE"; then
  printf "\n\nJira issue: %s\n" "$JIRA_ISSUE_NUMBER" >> "$COMMIT_MSG_FILE"
fi
